import { Meta } from '@storybook/addon-docs/blocks'

<Meta title="Unit testing" />

## Unit testing

We use Jest for automated testing, and all test files for Gatsby are located in `./src/__tests__`. Test files are structured following their related components.

When you make a change to an interface, you will need to [update the Jest snapshot](https://jestjs.io/docs/en/snapshot-testing) for tests to complete successfully:

```shell
npm run test:update
```

Before pushing your local branch to the repository, make sure to run:

```shell
npm run test
```

And make sure that every test passes. Pull requests are automatically checked against these same tests.

## API Testing

A number of tests exist here to do some basic testing of the API. For example:

### Build Process

These tests do exist in other places (see [quality-control](https://github.com/COVID19Tracking/quality-control)). However, it makes some sense to have them here as this is where the logic resides to construct the JSON/CSV files served by the API.

### Troubleshooting

You must have the API files installed locally.

```bash
> npm run setup:api-data
```

## Running the tests

```bash
> npm run api:test
```

## Anomalies

In `api-test.js` there are a number of tests to check that the daily states API records are cumulative (i.e., they should never decrease). Since the state websites are the authority, there will be times where this does not hold true. In such events, data should be verified via screenshots or with the Data Entry team and exceptions should be added to the `allowedPositiveAnomalies` and `allowedNegativeAnomalies` arrays.
