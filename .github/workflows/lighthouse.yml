name: Lighthouse audit
on: pull_request

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: 'Wait for deploy preview to finish'
        uses: 'WyriHaximus/github-action-wait-for-status@master'
        with:
          # We care only about the Netlify checks finishing
          ignoreActions: 'Lighthouse audit'
          checkInterval: 20
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v2
        with:
          urls: |
            https://deploy-preview-${{ github.event.number }}--covid-kevee-test.netlify.com/
          budgetPath: ./budget.json # test performance budgets
          uploadArtifacts: true
          temporaryPublicStorage: true
      - name: Audit Netlify deploy preview
        uses: jakejarvis/lighthouse-action@master
        with:
          netlify_site: 'covid-kevee-test.netlify.com'
      - uses: actions/upload-artifact@master
        with:
          name: report
          path: './report'
